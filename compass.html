<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Love Compass</title>

  <!-- Minecraft-style font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>

  <style>
    body {
      margin: 0;
      padding: 1rem;
      font-family: 'Press Start 2P', monospace;
      background-color: #789262;
      background-image:
        linear-gradient(0deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent),
        linear-gradient(90deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent);
      background-size: 32px 32px;
      color: #eee;
      text-align: center;
    }

    #info-panel {
      background: rgba(0,0,0,0.6);
      border: 4px solid #444;
      border-radius: 4px;
      padding: 1rem;
      max-width: 360px;
      margin: 1rem auto;
      box-shadow: 0 0 8px #000;
    }

    #info-panel div {
      text-align: left;
      margin-bottom: .75rem;
    }

    h1, p, label {
      margin: 0;
      font-size: .8rem;
    }

    #compass-sprite {
      width: 64px;
      height: 64px;
      margin: 1rem auto;
      /* your 16-frame sprite: replace this data-URI with your real PNG */
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAQAAQMAAADRgX37AAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAAAJtJREFUeF7twQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgD4fAAAGFQ71wAAAABJRU5ErkJggg==');
      background-repeat: no-repeat;
      image-rendering: pixelated;
      background-size: 1024px 64px; /* 16×64px frames in a row */
    }

    @keyframes twitch {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.6; }
    }
    .twitch {
      animation: twitch 0.3s ease-in-out;
    }

    @media (max-width:500px) {
      body { padding: .5rem; }
      #compass-sprite { width: 48px; height: 48px; background-size: 768px 48px; }
    }
  </style>
</head>
<body>
  <div id="info-panel">
    <h1>Love Compass</h1>
    <div>
      <label>Your Name:</label>
      <div id="yourName"></div>
    </div>
    <div>
      <label>Lover’s Name:</label>
      <div id="loverName"></div>
    </div>
  </div>

  <div id="compass-sprite" class="frame-0"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // redirect if no names
    const you   = localStorage.getItem('yourID');
    const lover = localStorage.getItem('loverID');
    if (!you || !lover) location.href = 'index.html';

    document.getElementById('yourName').textContent  = you;
    document.getElementById('loverName').textContent = lover;

    // init Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCcAduuqgdNmrhQtQHmtnL0kQwXZPu9b2A",
      authDomain: "compassapp-cb4ed.firebaseapp.com",
      databaseURL: "https://compassapp-cb4ed-default-rtdb.firebaseio.com",
      projectId: "compassapp-cb4ed",
      storageBucket: "compassapp-cb4ed.appspot.com",
      messagingSenderId: "820890755353",
      appId: "1:820890755353:web:d4e33e791f925166506588"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // geography math
    function toRad(d){ return d*Math.PI/180; }
    function getBearing(lat1, lon1, lat2, lon2){
      const dLon = toRad(lon2 - lon1),
            y = Math.sin(dLon)*Math.cos(toRad(lat2)),
            x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2))
              - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon),
            brg = Math.atan2(y, x)*180/Math.PI;
      return (brg + 360)%360;
    }

    const sprite = document.getElementById('compass-sprite');
    let yourPos = {}, loverPos = {};

    function updateCompass(){
      const brg = getBearing(
        yourPos.lat, yourPos.lon,
        loverPos.lat, loverPos.lon
      );
      // map 0–360 to 0–15
      const idx = Math.floor((brg + 11.25)/22.5) % 16;
      // move sprite
      const x = -idx * 64;
      sprite.style.backgroundPosition = `${x}px 0`;
      // twitch
      sprite.classList.remove('twitch');
      void sprite.offsetWidth;
      sprite.classList.add('twitch');
    }

    function startTracking(){
      // watch yours
      navigator.geolocation.watchPosition(pos=>{
        yourPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        db.ref('users/' + you).set(yourPos);
      }, _=>alert('Enable GPS'), { enableHighAccuracy:true });

      // watch lover
      db.ref('users/' + lover).on('value', snap=>{
        const d = snap.val();
        if (d && d.lat!=null && d.lon!=null) {
          loverPos = { lat: d.lat, lon: d.lon };
          updateCompass();
        }
      });
    }

    startTracking();
  </script>
</body>
</html>
