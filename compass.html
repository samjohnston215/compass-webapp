<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Love Compass</title>

  <!-- Pixel font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0; padding: 1rem;
      font-family: 'Press Start 2P', monospace;
      background-color: #789262;
      background-image:
        linear-gradient(0deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent),
        linear-gradient(90deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent);
      background-size: 32px 32px;
      color: #eee; text-align: center;
    }

    #info-panel {
      background: rgba(0,0,0,0.6);
      border: 4px solid #444; border-radius: 4px;
      padding: 1rem; max-width: 360px; margin: 1rem auto;
      box-shadow: 0 0 8px #000;
    }

    #info-panel div { text-align: left; margin-bottom: .75rem; }
    #info-panel h1 { margin: 0 0 .5rem; }
    #info-panel label { font-size: .7rem; margin-bottom: .2rem; }

    #compass {
      width: 260px; height: 260px; margin: 1rem auto;
    }

    svg {
      width: 100%; height: 100%;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      shape-rendering: crispEdges;
    }

    .needle-sprite { display: none; }
    .visible      { display: block; }

    @keyframes twitch {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.6; }
    }
    .twitch { animation: twitch 0.3s ease-in-out; }

    @media (max-width:500px) {
      body { padding: .5rem; }
      #compass { width: 200px; height: 200px; }
    }
  </style>
</head>
<body>
  <div id="info-panel">
    <h1>Love Compass</h1>
    <div>
      <label>Your Name:</label>
      <div id="yourName"></div>
    </div>
    <div>
      <label>Loverâ€™s Name:</label>
      <div id="loverName"></div>
    </div>
  </div>

  <div id="compass">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <!-- Base face -->
      <rect x="0" y="0" width="64" height="64" fill="#777"/>
      <rect x="4" y="4" width="56" height="56" fill="#222"/>
      <rect x="8" y="8" width="48" height="48" fill="#ccc"/>
      <rect x="10" y="10" width="44" height="44" fill="#eee"/>
      <g fill="#333">
        <rect x="31" y="8"  width="2" height="8"/>
        <rect x="31" y="48" width="2" height="8"/>
        <rect x="8"  y="31" width="8" height="2"/>
        <rect x="48" y="31" width="8" height="2"/>
      </g>

      <!-- 8 discrete needle sprites -->
      <g id="needle-0" class="needle-sprite" transform="rotate(0,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-1" class="needle-sprite" transform="rotate(45,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-2" class="needle-sprite" transform="rotate(90,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-3" class="needle-sprite" transform="rotate(135,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-4" class="needle-sprite" transform="rotate(180,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-5" class="needle-sprite" transform="rotate(225,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-6" class="needle-sprite" transform="rotate(270,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
      <g id="needle-7" class="needle-sprite" transform="rotate(315,32,32)">
        <rect x="30" y="12" width="4" height="20" fill="#ff4444"/>
        <rect x="28" y="12" width="8" height="4" fill="#ff4444"/>
        <rect x="30" y="32" width="4" height="20" fill="#fff"/>
        <rect x="28" y="48" width="8" height="4" fill="#fff"/>
      </g>
    </svg>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Redirect if unset
    const you   = localStorage.getItem('yourID');
    const lover = localStorage.getItem('loverID');
    if (!you || !lover) location.href = 'index.html';

    document.getElementById('yourName').textContent  = you;
    document.getElementById('loverName').textContent = lover;

    // Firebase Init
    const firebaseConfig = {
      apiKey: "AIzaSyCcAduuqgdNmrhQtQHmtnL0kQwXZPu9b2A",
      authDomain: "compassapp-cb4ed.firebaseapp.com",
      databaseURL: "https://compassapp-cb4ed-default-rtdb.firebaseio.com",
      projectId: "compassapp-cb4ed",
      storageBucket: "compassapp-cb4ed.appspot.com",
      messagingSenderId: "820890755353",
      appId: "1:820890755353:web:d4e33e791f925166506588"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Bearing math
    function toRad(d){ return d * Math.PI/180; }
    function getBearing(lat1, lon1, lat2, lon2) {
      const dLon = toRad(lon2 - lon1),
            y    = Math.sin(dLon)*Math.cos(toRad(lat2)),
            x    = Math.cos(toRad(lat1))*Math.sin(toRad(lat2))
                 - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon),
            brg  = Math.atan2(y, x)*180/Math.PI;
      return (brg + 360) % 360;
    }

    let yourPos = {}, loverPos = {};

    function showNeedle(angle) {
      const idx = Math.floor((angle + 22.5) / 45) % 8;
      document.querySelectorAll('.needle-sprite').forEach((g, i) => {
        const vis = i === idx;
        g.classList.toggle('visible', vis);
        if (vis) {
          g.classList.remove('twitch');
          void g.offsetWidth;
          g.classList.add('twitch');
        }
      });
    }

    function updateCompass() {
      const brg = getBearing(
        yourPos.lat, yourPos.lon,
        loverPos.lat, loverPos.lon
      );
      showNeedle(brg);
    }

    function startTracking() {
      navigator.geolocation.watchPosition(pos => {
        yourPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        db.ref('users/' + you).set(yourPos);
      }, () => alert('Enable GPS for Love Compass'), { enableHighAccuracy: true });

      db.ref('users/' + lover).on('value', snap => {
        const d = snap.val();
        if (d && d.lat != null && d.lon != null) {
          loverPos = { lat: d.lat, lon: d.lon };
          updateCompass();
        }
      });
    }

    startTracking();
  </script>
</body>
</html>
