<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Love Compass</title>

  <!-- Minecraft-style pixel font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>

  <style>
    body {
      margin: 0; padding: 1rem;
      font-family: 'Press Start 2P', monospace;
      background-color: #789262;
      background-image:
        linear-gradient(0deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent),
        linear-gradient(90deg,transparent 24%,rgba(0,0,0,0.06)25%,rgba(0,0,0,0.06)26%,transparent 27%,transparent 74%,rgba(0,0,0,0.06)75%,rgba(0,0,0,0.06)76%,transparent 77%,transparent);
      background-size: 32px 32px;
      color: #eee; text-align: center;
    }
    #info-panel {
      background: rgba(0,0,0,0.6);
      border: 4px solid #444; border-radius: 4px;
      padding: 1rem; max-width: 360px; margin: 1rem auto;
      box-shadow: 0 0 8px #000;
    }
    #info-panel div { text-align: left; margin-bottom: .75rem; }
    h1, label { margin: 0; font-size: .8rem; }
    #compass {
      width: 260px; height: 260px; margin: 1rem auto;
    }
    svg {
      width: 100%; height: 100%;
      image-rendering: crisp-edges;
      image-rendering: pixelated;
      shape-rendering: crispEdges;
    }
    .needle-sprite { display: none; }
    .visible { display: block; }
    @keyframes twitch {
      0%,100% { opacity: 1; }
      50%      { opacity: 0.6; }
    }
    .twitch { animation: twitch 0.3s ease-in-out; }
    @media (max-width:500px) {
      body { padding: .5rem; }
      #compass { width: 200px; height: 200px; }
    }
  </style>
</head>
<body>
  <div id="info-panel">
    <h1>Love Compass</h1>
    <div>
      <label>Your Name:</label>
      <div id="yourName"></div>
    </div>
    <div>
      <label>Lover’s Name:</label>
      <div id="loverName"></div>
    </div>
  </div>

  <div id="compass">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
      <!-- Outer square -->
      <rect x="0" y="0" width="64" height="64" fill="#777"/>
      <!-- Inner face -->
      <rect x="4" y="4" width="56" height="56" fill="#222"/>
      <rect x="8" y="8" width="48" height="48" fill="#ccc"/>
      <rect x="10" y="10" width="44" height="44" fill="#eee"/>
      <!-- Tick marks -->
      <g fill="#333">
        <rect x="31" y="8"  width="2" height="8"/>
        <rect x="31" y="48" width="2" height="8"/>
        <rect x="8"  y="31" width="8" height="2"/>
        <rect x="48" y="31" width="8" height="2"/>
      </g>

      <!-- 16 discrete needle groups (22.5° increments) -->
      <!-- Each group holds the same pixel-art needle centered at (32,32), rotated in its <g> -->
      <g class="needle-sprite" id="needle-0"  transform="rotate(   0, 32,32)"><!--▲-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-1"  transform="rotate( 22.5, 32,32)"><!--↗-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-2"  transform="rotate( 45, 32,32)"><!--▶-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-3"  transform="rotate( 67.5, 32,32)"><!--↘-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-4"  transform="rotate( 90, 32,32)"><!--▼-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-5"  transform="rotate(112.5, 32,32)"><!--↙-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-6"  transform="rotate(135, 32,32)"><!--◀-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-7"  transform="rotate(157.5,32,32)"><!--↖-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-8"  transform="rotate(180,32,32)"><!--▲-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-9"  transform="rotate(202.5,32,32)"><!--↗-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-10" transform="rotate(225,32,32)"><!--▶-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-11" transform="rotate(247.5,32,32)"><!--↘-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-12" transform="rotate(270,32,32)"><!--▼-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-13" transform="rotate(292.5,32,32)"><!--↙-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-14" transform="rotate(315,32,32)"><!--◀-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
      <g class="needle-sprite" id="needle-15" transform="rotate(337.5,32,32)"><!--↖-->
        <polygon points="32,12 28,32 36,32" fill="#ff4444"/>
        <polygon points="32,52 28,32 36,32" fill="#fff"/>
      </g>
    </svg>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Redirect back if unset
    const you   = localStorage.getItem('yourID');
    const lover = localStorage.getItem('loverID');
    if (!you || !lover) location.href = 'index.html';
    document.getElementById('yourName').textContent  = you;
    document.getElementById('loverName').textContent = lover;

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCcAduuqgdNmrhQtQHmtnL0kQwXZPu9b2A",
      authDomain: "compassapp-cb4ed.firebaseapp.com",
      databaseURL: "https://compassapp-cb4ed-default-rtdb.firebaseio.com",
      projectId: "compassapp-cb4ed",
      storageBucket: "compassapp-cb4ed.appspot.com",
      messagingSenderId: "820890755353",
      appId: "1:820890755353:web:d4e33e791f925166506588"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Bearing calculation
    function toRad(d){ return d * Math.PI/180; }
    function getBearing(lat1,lon1,lat2,lon2){
      const dLon = toRad(lon2 - lon1),
            y = Math.sin(dLon) * Math.cos(toRad(lat2)),
            x = Math.cos(toRad(lat1))*Math.sin(toRad(lat2))
              - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(dLon),
            brg = Math.atan2(y,x)*180/Math.PI;
      return (brg + 360) % 360;
    }

    let yourPos = {}, loverPos = {};

    function showNeedle(angle) {
      const idx = Math.floor((angle + 11.25) / 22.5) % 16;
      document.querySelectorAll('.needle-sprite').forEach((g, i) => {
        g.classList.toggle('visible', i === idx);
        if (i === idx) {
          g.classList.remove('twitch');
          void g.offsetWidth;
          g.classList.add('twitch');
        }
      });
    }

    function update() {
      const b = getBearing(yourPos.lat, yourPos.lon, loverPos.lat, loverPos.lon);
      showNeedle(b);
    }

    function startTracking() {
      navigator.geolocation.watchPosition(pos => {
        yourPos = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        db.ref('users/' + you).set(yourPos);
      }, () => alert('Enable GPS for Love Compass'), { enableHighAccuracy: true });

      db.ref('users/' + lover).on('value', snap => {
        const d = snap.val();
        if (d && d.lat != null && d.lon != null) {
          loverPos = { lat: d.lat, lon: d.lon };
          update();
        }
      });
    }

    startTracking();
  </script>
</body>
</html>
