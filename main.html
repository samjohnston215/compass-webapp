<!-- main.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Love Compass</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --serenity-green: #89a32e; /* Slightly darker green */
      --athloi-lavender: #B57EDC;
    }
    body {
      font-family: 'Press Start 2P', monospace;
      margin: 0;
      padding: 1rem;
      text-align: center;
      color: white;
      min-height: 100vh;
      background-color: var(--serenity-green);
      transition: background-color 0.5s ease;
    }

    .info-panel {
      max-width: 400px;
      margin: auto;
      padding: 1rem;
      background: rgba(0,0,0,0.6);
      border: 3px solid white;
      border-radius: 10px;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    #compass-img {
      max-width: 90vmin;
      height: auto;
      image-rendering: pixelated;
      margin: 20px auto;
      display: none; /* Hidden initially, shown when location ready */
    }

    #status-message {
      color: yellow;
      font-family: 'Press Start 2P', monospace;
      margin-top: 1rem;
      min-height: 1.4em;
    }

    @media (max-width: 500px) {
      #compass-img {
        max-width: 95vmin;
      }
    }
  </style>
</head>
<body>
  <div class="info-panel">
    <div><strong>Your ID:</strong> <span id="yourName"></span></div>
    <div><strong>Loverâ€™s ID:</strong> <span id="loverName"></span></div>
  </div>

  <img id="compass-img" src="" alt="Compass Frame" />
  <div id="status-message"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCcAduuqgdNmrhQtQHmtnL0kQwXZPu9b2A",
      authDomain: "compassapp-cb4ed.firebaseapp.com",
      databaseURL: "https://compassapp-cb4ed-default-rtdb.firebaseio.com",
      projectId: "compassapp-cb4ed",
      storageBucket: "compassapp-cb4ed.appspot.com",
      messagingSenderId: "820890755353",
      appId: "1:820890755353:web:d4e33e791f925166506588"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const auth = firebase.auth();

    const yourID = localStorage.getItem('yourID');
    const loverID = localStorage.getItem('loverID');

    const emailMap = {
      "Serenitym16": "serenitym16@example.com",
      "athloi": "athloi@example.com"
    };
    const passwordMap = {
      "Serenitym16": "password123",
      "athloi": "password123"
    };

    document.getElementById('yourName').textContent = yourID;
    document.getElementById('loverName').textContent = loverID;

    // Update background color based on yourID
    function updateBackgroundColor(id) {
      if (id.toLowerCase() === 'serenitym16') {
        document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--serenity-green');
      } else if (id.toLowerCase() === 'athloi') {
        document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--athloi-lavender');
      } else {
        document.body.style.backgroundColor = '#1d1d1d';
      }
    }
    updateBackgroundColor(yourID);

    function toRad(d) {
      return d * Math.PI / 180;
    }
    function getBearing(lat1, lon1, lat2, lon2) {
      const dLon = toRad(lon2 - lon1);
      const y = Math.sin(dLon) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
      const brg = Math.atan2(y, x) * 180 / Math.PI;
      return (brg + 360) % 360;
    }

    const statusMsg = document.getElementById('status-message');
    const compassImg = document.getElementById('compass-img');
    const totalFrames = 29;

    let yourPos = {}, loverPos = null;
    let lastLoverUpdate = 0;

    function showNeedle(angle) {
      if (angle == null || loverPos === null) {
        compassImg.style.display = 'none';
        return;
      }
      compassImg.style.display = 'block';
      const frameIdx = Math.floor((angle / 360) * totalFrames) % totalFrames;
      const padded = frameIdx.toString().padStart(2, '0');
      const imgURL = `images/needle-frames/frame_${padded}_delay-0.06s.png`;
      compassImg.src = imgURL;
    }

    function updateCompass() {
      if (yourPos.lat && loverPos && loverPos.lat) {
        const brg = getBearing(yourPos.lat, yourPos.lon, loverPos.lat, loverPos.lon);
        showNeedle(brg);
      } else {
        showNeedle(null);
      }
    }

    function startTracking() {
      navigator.geolocation.watchPosition(pos => {
        yourPos = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        };
        db.ref('users/' + yourID).set(yourPos);
      }, () => alert('Location permission denied'), {
        enableHighAccuracy: true
      });

      db.ref('users/' + loverID).on('value', snapshot => {
        const data = snapshot.val();
        if (data && data.lat != null && data.lon != null) {
          loverPos = { lat: data.lat, lon: data.lon };
          updateCompass();
          statusMsg.textContent = '';  // Clear status message on valid data
          lastLoverUpdate = Date.now();
        } else {
          loverPos = null;
          updateCompass();
          statusMsg.textContent = `Waiting for ${loverID}'s location...`;
        }
      });

      // Periodic check for stale data
      setInterval(() => {
        if (!lastLoverUpdate || (Date.now() - lastLoverUpdate > 30000)) {
          statusMsg.textContent = `${loverID}'s location is unavailable or outdated.`;
          loverPos = null;
          updateCompass();
        }
      }, 5000);
    }

    // Firebase Authentication and Start Tracking
    auth.onAuthStateChanged(user => {
      if (user) {
        startTracking();
      } else {
        const email = emailMap[yourID];
        const password = passwordMap[yourID];

        if (!email || !password) {
          alert("Login config not found. Check index.html setup.");
          return;
        }

        auth.signInWithEmailAndPassword(email, password)
          .then(() => startTracking())
          .catch(err => alert("Auth failed: " + err.message));
      }
    });

    // Redirect if missing info
    if (!yourID || !loverID) {
      alert("Missing ID info. Returning to start.");
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
